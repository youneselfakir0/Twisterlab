# =============================================================================
# TwisterLab Ingress Controller Configuration
# =============================================================================
# Configuration Ingress avec:
# - TLS/SSL termination
# - Path-based routing
# - Rate limiting
# - CORS headers
# - Health check paths
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: twisterlab-ingress
  namespace: twisterlab
  labels:
    app: twisterlab
    component: ingress
  annotations:
    # Ingress class
    kubernetes.io/ingress.class: "nginx"
    
    # SSL/TLS
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"
    
    # Timeouts
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    
    # Buffer sizes
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
    
    # CORS
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
    
    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Sticky sessions (optionnel pour WebSocket)
    # nginx.ingress.kubernetes.io/affinity: "cookie"
    # nginx.ingress.kubernetes.io/session-cookie-name: "twisterlab-session"
    # nginx.ingress.kubernetes.io/session-cookie-expires: "172800"
    # nginx.ingress.kubernetes.io/session-cookie-max-age: "172800"

spec:
  ingressClassName: nginx
  
  # TLS Configuration
  tls:
    - hosts:
        - twisterlab.example.com
        - api.twisterlab.example.com
      secretName: twisterlab-tls-secret
  
  rules:
    # Main API
    - host: api.twisterlab.example.com
      http:
        paths:
          # API endpoints
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: twisterlab-api-ha
                port:
                  number: 80
          
          # MCP endpoints
          - path: /mcp
            pathType: Prefix
            backend:
              service:
                name: twisterlab-api-ha
                port:
                  number: 80
          
          # Health check
          - path: /health
            pathType: Exact
            backend:
              service:
                name: twisterlab-api-ha
                port:
                  number: 80
          
          # Metrics (protected)
          - path: /metrics
            pathType: Exact
            backend:
              service:
                name: twisterlab-api-ha
                port:
                  number: 80
          
          # Root - redirect to docs
          - path: /
            pathType: Prefix
            backend:
              service:
                name: twisterlab-api-ha
                port:
                  number: 80

    # Dashboard/Monitoring (optionnel)
    - host: monitoring.twisterlab.example.com
      http:
        paths:
          - path: /grafana
            pathType: Prefix
            backend:
              service:
                name: grafana
                port:
                  number: 3000
          
          - path: /prometheus
            pathType: Prefix
            backend:
              service:
                name: prometheus
                port:
                  number: 9090

---
# =============================================================================
# TLS Secret Template (à remplacer avec cert-manager en production)
# =============================================================================
# Pour générer un certificat auto-signé (dev only):
# openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#   -keyout tls.key -out tls.crt \
#   -subj "/CN=twisterlab.example.com"
# kubectl create secret tls twisterlab-tls-secret --cert=tls.crt --key=tls.key -n twisterlab
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: twisterlab-tls-secret
  namespace: twisterlab
  labels:
    app: twisterlab
type: kubernetes.io/tls
data:
  # Placeholder - à remplacer avec vrais certificats
  # Ces valeurs sont des placeholders base64
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCi4uLgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCi4uLgotLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tCg==

---
# =============================================================================
# Cert-Manager ClusterIssuer (Let's Encrypt Production)
# =============================================================================
# Décommenter et configurer pour production avec Let's Encrypt
# =============================================================================
# apiVersion: cert-manager.io/v1
# kind: ClusterIssuer
# metadata:
#   name: letsencrypt-prod
# spec:
#   acme:
#     server: https://acme-v02.api.letsencrypt.org/directory
#     email: admin@twisterlab.example.com
#     privateKeySecretRef:
#       name: letsencrypt-prod-key
#     solvers:
#       - http01:
#           ingress:
#             class: nginx

---
# =============================================================================
# Certificate Resource (avec cert-manager)
# =============================================================================
# apiVersion: cert-manager.io/v1
# kind: Certificate
# metadata:
#   name: twisterlab-certificate
#   namespace: twisterlab
# spec:
#   secretName: twisterlab-tls-secret
#   issuerRef:
#     name: letsencrypt-prod
#     kind: ClusterIssuer
#   commonName: twisterlab.example.com
#   dnsNames:
#     - twisterlab.example.com
#     - api.twisterlab.example.com
#     - monitoring.twisterlab.example.com

---
# =============================================================================
# LoadBalancer Service (pour cloud providers)
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: twisterlab-loadbalancer
  namespace: twisterlab
  labels:
    app: twisterlab
    component: loadbalancer
  annotations:
    # AWS ALB
    # service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    # service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    
    # Azure
    # service.beta.kubernetes.io/azure-load-balancer-internal: "false"
    
    # GCP
    # cloud.google.com/load-balancer-type: "External"
    
    # MetalLB (bare-metal)
    metallb.universe.tf/address-pool: production
spec:
  type: LoadBalancer
  # Pour environnement local (minikube/k3s), utiliser NodePort
  # type: NodePort
  externalTrafficPolicy: Local
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP
    - name: https
      port: 443
      targetPort: 443
      protocol: TCP
  selector:
    app: ingress-nginx
    component: controller
