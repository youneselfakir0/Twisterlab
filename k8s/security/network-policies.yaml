# Kubernetes Network Policies for TwisterLab
# TwisterLab v3.2.1 - Security Enhancement
# 
# These policies restrict network traffic between namespaces
# and limit exposure to only necessary services.

---
# Default deny all ingress traffic in twisterlab namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: twisterlab
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
# Allow ingress to API and MCP services from anywhere (NodePort)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-api-ingress
  namespace: twisterlab
spec:
  podSelector:
    matchLabels:
      app: twisterlab-unified-api
  policyTypes:
  - Ingress
  ingress:
  - ports:
    - protocol: TCP
      port: 8000

---
# Allow ingress to MCP Unified from anywhere (NodePort)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-mcp-ingress
  namespace: twisterlab
spec:
  podSelector:
    matchLabels:
      app: mcp-unified
  policyTypes:
  - Ingress
  ingress:
  - ports:
    - protocol: TCP
      port: 8080

---
# Allow internal communication for PostgreSQL
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-postgres-internal
  namespace: twisterlab
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  ingress:
  # Allow from twisterlab namespace pods
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 5432
  # Allow from monitoring namespace (exporters)
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 5432

---
# Allow internal communication for Redis
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-redis-internal
  namespace: twisterlab
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
  - Ingress
  ingress:
  # Allow from twisterlab namespace pods
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 6379
  # Allow from monitoring namespace (exporters)
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 6379

---
# Allow Prometheus to scrape metrics from all pods in twisterlab
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-scrape
  namespace: twisterlab
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9121  # Redis exporter
    - protocol: TCP
      port: 9187  # PostgreSQL exporter
    - protocol: TCP
      port: 8000  # API metrics
    - protocol: TCP
      port: 8080  # MCP metrics

---
# Default deny all ingress in monitoring namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: monitoring
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
# Allow ingress to Prometheus (NodePort 30090)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-ingress
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app: prometheus
  policyTypes:
  - Ingress
  ingress:
  - ports:
    - protocol: TCP
      port: 9090

---
# Allow ingress to Grafana (NodePort 30091)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-grafana-ingress
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app: grafana
  policyTypes:
  - Ingress
  ingress:
  - ports:
    - protocol: TCP
      port: 3000

---
# Allow Grafana to query Prometheus
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-grafana-to-prometheus
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app: prometheus
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: grafana
    ports:
    - protocol: TCP
      port: 9090
